<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GATE Subjects Insights — Visual</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Annotation Plugin for Deadlines -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <!-- Phosphor Icons (Professional Icon Pack) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root {
      --primary: #ff6f61;
      --primary-hover: #ff4b3e;
      --bg-gradient: linear-gradient(135deg, #f8f9fa, #e9ecef);
      --card-bg: #ffffff;
      --text-main: #2d3748;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      
      /* Level Colors */
      --l1-color: #c53030; --l1-bg: #fff5f5;
      --l2-color: #d69e2e; --l2-bg: #fffff0;
      --l3-color: #38a169; --l3-bg: #f0fff4;
      --opt-color: #718096; --opt-bg: #edf2f7;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      text-align: center;
      min-height: 100vh;
    }

    h1 {
      color: var(--primary);
      font-size: 2.2rem;
      margin-bottom: 24px;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    h1 i { font-size: 2.4rem; }

    /* Controls & Buttons */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn {
      background: var(--card-bg);
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover, .btn.active {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(255, 111, 97, 0.3);
    }

    .btn-overall {
      background: var(--text-main);
      color: white;
      border-color: var(--text-main);
    }
    .btn-overall:hover {
      background: #1a202c;
      border-color: #1a202c;
    }
    
    .btn-pareto {
      background: #6b46c1; 
      color: white;
      border-color: #6b46c1;
    }
    .btn-pareto:hover, .btn-pareto.active {
      background: #553c9a;
      border-color: #553c9a;
    }

    .btn-timeline {
      background: #319795;
      color: white;
      border-color: #319795;
    }
    .btn-timeline:hover, .btn-timeline.active {
      background: #285e61;
      border-color: #285e61;
    }

    /* Layout */
    .dashboard, .timeline-view {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
      text-align: left;
    }

    @media (min-width: 900px) {
      .dashboard {
        grid-template-columns: 350px 1fr; 
      }
      .timeline-view {
        grid-template-columns: 1fr; /* Stacked layout for timeline */
      }
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 24px;
      position: relative;
    }
    
    .timeline-full { grid-column: 1 / -1; }

    .summary-card { height: fit-content; }

    .charts-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Chart Wrappers */
    .chart-box {
      position: relative;
      height: 350px;
      width: 100%;
    }
    .chart-box.small { height: 300px; }

    h2, h3 { margin-top: 0; color: var(--text-main); }
    h3 { font-size: 1.2rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 5px;
      text-align: center;
      transition: transform 0.2s, border-color 0.2s;
    }
    .stat-box:hover { transform: translateY(-2px); border-color: var(--primary); }
    .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; }
    .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
    .stat-value.highlight { color: var(--primary); }

    /* Topic List */
    .topic-header { font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; }
    ul.topic-list { list-style: none; padding: 0; margin: 0; }
    ul.topic-list li {
      padding: 10px; background: #fff; border: 1px solid #edf2f7; margin-bottom: 8px; border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
    }
    ul.topic-list li b { background: var(--bg-gradient); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; color: var(--primary); }

    /* Pareto View */
    .pareto-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      text-align: left;
    }
    .pareto-col { background: white; border-radius: 16px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 15px; }
    .pareto-header { font-size: 1.1rem; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .p-card {
      padding: 12px; border-radius: 8px; border-left: 4px solid transparent; font-size: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .p-card .p-info { display: flex; flex-direction: column; }
    .p-card .p-subj { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; font-weight: 600; }
    .p-card .p-topic { font-weight: 600; color: #2d3748; }
    .p-card .p-score { font-weight: 700; font-size: 1rem; }

    /* Levels */
    .lvl-1 { border-top: 4px solid var(--l1-color); } .lvl-1 .p-card { background: var(--l1-bg); border-left-color: var(--l1-color); } .lvl-1 .p-score { color: var(--l1-color); }
    .lvl-2 { border-top: 4px solid var(--l2-color); } .lvl-2 .p-card { background: var(--l2-bg); border-left-color: var(--l2-color); } .lvl-2 .p-score { color: var(--l2-color); }
    .lvl-3 { border-top: 4px solid var(--l3-color); } .lvl-3 .p-card { background: var(--l3-bg); border-left-color: var(--l3-color); } .lvl-3 .p-score { color: var(--l3-color); }
    .lvl-opt { border-top: 4px solid var(--opt-color); } .lvl-opt .p-card { background: var(--opt-bg); border-left-color: var(--opt-color); } .lvl-opt .p-score { color: var(--opt-color); }

    /* Timeline Specifics */
    .roadmap-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .phase-card {
        padding: 20px; border-radius: 14px; color: #2d3748;
        border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 8px;
        position: relative; overflow: hidden;
    }
    .phase-card h4 { margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .phase-card .date { font-size: 1.4rem; font-weight: 800; color: #2d3748; margin: 5px 0; }
    .phase-card .meta { font-size: 0.85rem; opacity: 0.8; }
    
    .phase-1 { background: #fff5f5; border-color: #feb2b2; } .phase-1 h4 { color: #c53030; }
    .phase-2 { background: #fffaf0; border-color: #fbd38d; } .phase-2 h4 { color: #c05621; }
    .phase-3 { background: #f0fff4; border-color: #9ae6b4; } .phase-3 h4 { color: #276749; }

    .velocity-pill {
        background: #2d3748; color: white; border-radius: 12px; padding: 4px 12px; 
        font-size: 0.8rem; width: fit-content; margin-top: auto;
    }

    /* Utility */
    .hidden { display: none !important; }
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%;
      width: 30px; height: 30px; animation: spin 0.8s linear infinite; margin: 40px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }

    #backBtn { margin-top: 40px; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
    #backBtn:hover { background: #f7fafc; color: var(--text-main); }
  </style>
</head>
<body>

  <h1><i class="ph-duotone ph-chart-polar"></i> GATE Strategy Hub</h1>

  <!-- Navigation -->
  <div class="controls">
    <button class="btn" data-file="data/algorithms.json">Algorithms</button>
    <button class="btn" data-file="data/dbms.json">DBMS</button>
    <button class="btn" data-file="data/operating_system.json">OS</button>
    <button class="btn" data-file="data/computer_networks.json">CN</button>
    <button class="btn" data-file="data/digital_logic.json">Digital</button>
    <button class="btn" data-file="data/computer_architecture.json">COA</button>
    <button class="btn" data-file="data/theory_of_computation.json">TOC</button>
    <button class="btn" data-file="data/compiler_design.json">CD</button>
    <button class="btn" data-file="data/data_structures.json">DS</button>
    <button class="btn" data-file="data/engineering_maths.json">Math</button>
    <button class="btn" data-file="data/aptitude.json">Apt</button>
    
    <div style="width: 100%; height: 0;"></div> <!-- Break row -->
    <button class="btn btn-overall" id="overallBtn"><i class="ph ph-globe"></i> Overall Strategy</button>
    <button class="btn btn-pareto" id="paretoBtn"><i class="ph ph-lightning"></i> Pareto (80/20)</button>
    <button class="btn btn-timeline" id="timelineBtn"><i class="ph ph-calendar-check"></i> Roadmap Generator</button>
  </div>

  <!-- Loading Indicator -->
  <div id="loader" class="loader hidden"></div>

  <!-- Standard Dashboard Area -->
  <div class="dashboard hidden" id="mainDashboard">
    <!-- Left Column: Summary Stats -->
    <div class="card summary-card">
      <h3 id="sidebarTitle"><i class="ph ph-info"></i> Summary</h3>
      <div id="statsContent"></div>
    </div>

    <!-- Right Column: Charts -->
    <div class="charts-container">
      <div class="card">
        <h3 id="chart1Title"><i class="ph ph-chart-bar"></i> Topic Distribution</h3>
        <div class="chart-box">
          <canvas id="mainChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 id="chart2Title"><i class="ph ph-chart-pie-slice"></i> Focus Areas (Top 5 vs Rest)</h3>
        <div class="chart-box small">
          <canvas id="secondaryChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Pareto Dashboard Area -->
  <div class="pareto-container hidden" id="paretoDashboard">
    <div class="pareto-col lvl-1">
      <div class="pareto-header">
        <span><i class="ph-fill ph-fire" style="color:var(--l1-color)"></i> Vital Few</span>
        <span style="font-size:0.8rem; background:var(--l1-bg); padding:4px 8px; border-radius:12px; color:var(--l1-color)">Top 50%</span>
      </div>
      <div id="lvl1Content"></div>
    </div>
    <div class="pareto-col lvl-2">
      <div class="pareto-header">
        <span><i class="ph-fill ph-star" style="color:var(--l2-color)"></i> Core</span>
        <span style="font-size:0.8rem; background:var(--l2-bg); padding:4px 8px; border-radius:12px; color:var(--l2-color)">Next 30%</span>
      </div>
      <div id="lvl2Content"></div>
    </div>
    <div class="pareto-col lvl-3">
      <div class="pareto-header">
        <span><i class="ph-fill ph-check-circle" style="color:var(--l3-color)"></i> Low Priority</span>
        <span style="font-size:0.8rem; background:var(--l3-bg); padding:4px 8px; border-radius:12px; color:var(--l3-color)">Next 15%</span>
      </div>
      <div id="lvl3Content"></div>
    </div>
    <div class="pareto-col lvl-opt">
      <div class="pareto-header">
        <span><i class="ph-fill ph-dots-three-circle" style="color:var(--opt-color)"></i> Optional</span>
        <span style="font-size:0.8rem; background:var(--opt-bg); padding:4px 8px; border-radius:12px; color:var(--opt-color)">Remaining</span>
      </div>
      <div id="lvlOptContent"></div>
    </div>
  </div>

  <!-- Timeline / Hope Dashboard -->
  <div class="timeline-view hidden" id="timelineDashboard">
    
    <div style="margin-bottom: 10px;">
        <h2 style="text-align:center; font-size:1.5rem; color:#2d3748; margin-bottom:5px;">Your Strategic Roadmap</h2>
        <p style="text-align:center; color:#718096; margin-top:0;">Path to finish by Feb 5, 2026 (Dec 10 Start) — Technical Subjects Only</p>
    </div>

    <!-- Roadmap Cards -->
    <div class="roadmap-container" id="roadmapCards">
       <!-- Injected via JS -->
    </div>

    <!-- Burn Down Chart -->
    <div class="card timeline-full">
        <h3><i class="ph ph-trend-up"></i> Strategic Milestones (Burndown Chart)</h3>
        <div class="chart-box">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
  </div>

  <button class="btn" id="backBtn" onclick="alert('This would go back to index.html')"><i class="ph ph-arrow-left"></i> Back to Planner</button>

  <script>
    // --- Global State & Cache ---
    const dataCache = {}; 
    let mainChartInstance = null;
    let secondaryChartInstance = null;
    let timelineChartInstance = null;

    // --- Configuration ---
    const COLORS = ['#ff6f61', '#4fd1c5', '#f6ad55', '#63b3ed', '#9f7aea', '#ed64a6', '#a0aec0', '#48bb78', '#ecc94b', '#667eea'];
    
    // --- EXCLUDED SUBJECTS (Outliers) ---
    // Engineering Math, Aptitude, Discrete Maths
    const IGNORED_FILES = new Set([
      'data/engineering_maths.json', 
      'data/aptitude.json', 
      'data/discrete_maths.json'
    ]);

    // --- DOM Elements ---
    const loader = document.getElementById('loader');
    const dashboard = document.getElementById('mainDashboard');
    const paretoDashboard = document.getElementById('paretoDashboard');
    const timelineDashboard = document.getElementById('timelineDashboard');
    const statsContent = document.getElementById('statsContent');
    const sidebarTitle = document.getElementById('sidebarTitle');
    
    // --- Chart.js Defaults ---
    Chart.defaults.font.family = "'Poppins', sans-serif";
    Chart.defaults.color = '#718096';
    Chart.defaults.scale.grid.color = '#f1f5f9';

    // --- Helpers ---
    async function fetchData(url) {
      if (dataCache[url]) return dataCache[url];
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("File not found: " + url);
        const data = await res.json();
        dataCache[url] = data;
        return data;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    function destroyCharts() {
      if (Chart.getChart("mainChart")) Chart.getChart("mainChart").destroy();
      if (Chart.getChart("secondaryChart")) Chart.getChart("secondaryChart").destroy();
      if (Chart.getChart("timelineChart")) Chart.getChart("timelineChart").destroy();
    }

    function resetUI() {
      dashboard.classList.add('hidden');
      paretoDashboard.classList.add('hidden');
      timelineDashboard.classList.add('hidden');
      loader.classList.remove('hidden');
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
    }

    // --- Helper: Categorize Topics (Reused for Pareto & Timeline) ---
    function categorizeAllTopics(results) {
        const buckets = { l1: [], l2: [], l3: [], opt: [], totalTopics: 0 };
        
        results.forEach(sub => {
            const sorted = [...sub.data].sort((a,b)=>b.pyq - a.pyq);
            const total = sorted.reduce((s,t)=>s+t.pyq,0);
            let run = 0;
            sorted.forEach(t => {
                run += t.pyq;
                const prevPct = ((run - t.pyq)/total)*100;
                // Simplified Object
                const item = { subject: sub.subject, topic: t.topic, pyq: t.pyq };
                buckets.totalTopics++;

                if(prevPct < 50) buckets.l1.push(item);
                else if(prevPct < 80) buckets.l2.push(item);
                else if(prevPct < 95) buckets.l3.push(item);
                else buckets.opt.push(item);
            });
        });
        return buckets;
    }

    // --- VIEW 1: Subject Detail (Individual buttons still load all subjects) ---
    async function loadSubject(btn) {
      const url = btn.dataset.file;
      resetUI(); btn.classList.add('active');
      const data = await fetchData(url);
      loader.classList.add('hidden'); 
      
      if (!data || !data.length) {
         dashboard.classList.add('hidden');
         return alert("No data found for this subject.");
      }
      
      dashboard.classList.remove('hidden');

      sidebarTitle.innerHTML = `<i class="ph ph-book-bookmark"></i> ${btn.textContent}`;
      document.getElementById('chart1Title').innerHTML = `<i class="ph ph-chart-bar"></i> Topic Weightage`;
      document.getElementById('chart2Title').innerHTML = `<i class="ph ph-chart-pie"></i> Concentration`;

      renderSubjectStats(data);
      renderSubjectCharts(data);
    }

    function renderSubjectStats(data) {
      const total = data.reduce((s, i) => s + i.pyq, 0);
      const top3 = [...data].sort((a,b) => b.pyq - a.pyq).slice(0, 3);
      
      statsContent.innerHTML = `
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">Total PYQ</div><div class="stat-value highlight">${total}</div></div>
            <div class="stat-box"><div class="stat-label">Topics</div><div class="stat-value">${data.length}</div></div>
            <div class="stat-box"><div class="stat-label">Avg/Topic</div><div class="stat-value">${(total/data.length).toFixed(1)}</div></div>
        </div>
        <div class="topic-header"><i class="ph-fill ph-trend-up"></i> High Yield Topics</div>
        <ul class="topic-list">${top3.map(t => `<li><span>${t.topic}</span> <b>${t.pyq}</b></li>`).join('')}</ul>
      `;
    }

    function renderSubjectCharts(data) {
      destroyCharts();
      const sorted = [...data].sort((a, b) => b.pyq - a.pyq);
      
      // Bar Chart
      new Chart(document.getElementById('mainChart'), {
        type: 'bar',
        data: {
          labels: data.map(d => d.topic),
          datasets: [{ label: 'PYQs', data: data.map(d => d.pyq), backgroundColor: '#ff6f61', borderRadius: 4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Donut Chart
      const top5 = sorted.slice(0,5);
      const others = sorted.slice(5).reduce((s,t)=>s+t.pyq,0);
      new Chart(document.getElementById('secondaryChart'), {
        type: 'doughnut',
        data: {
          labels: [...top5.map(t=>t.topic), 'Others'],
          datasets: [{ data: [...top5.map(t=>t.pyq), others], backgroundColor: [...COLORS.slice(0,5), '#e2e8f0'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: {boxWidth: 10} } } }
      });
    }

    // --- VIEW 2: Overall (Filters Outliers) ---
    async function loadOverall() {
      resetUI(); document.getElementById('overallBtn').classList.add('active');
      
      // Filter Buttons
      const buttons = Array.from(document.querySelectorAll('.btn[data-file]'))
        .filter(btn => !IGNORED_FILES.has(btn.dataset.file));
      
      const fetchPromises = buttons.map(async btn => {
        const d = await fetchData(btn.dataset.file);
        return d ? { subject: btn.textContent, data: d } : null;
      });

      const results = (await Promise.all(fetchPromises)).filter(r => r !== null);
      loader.classList.add('hidden'); dashboard.classList.remove('hidden');
      processOverallData(results);
    }

    function processOverallData(results) {
        sidebarTitle.innerHTML = `<i class="ph ph-globe"></i> Overall Strategy`;
        const summary = results.map(r => {
            const total = r.data.reduce((s,t) => s+t.pyq, 0);
            return { subject: r.subject, totalPYQ: total, topics: r.data.length, score: 0 };
        });
        const max = Math.max(...summary.map(s=>s.totalPYQ));
        summary.forEach(s => s.score = (s.totalPYQ/max)*100);
        summary.sort((a,b) => b.score - a.score);

        const grandTotal = summary.reduce((a,s)=>a+s.totalPYQ,0);

        statsContent.innerHTML = `
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Total PYQ</div><div class="stat-value highlight">${grandTotal}</div></div>
                <div class="stat-box"><div class="stat-label">Subjects</div><div class="stat-value">${summary.length}</div></div>
                <div class="stat-box"><div class="stat-label">Avg/Sub</div><div class="stat-value">${(grandTotal/summary.length).toFixed(0)}</div></div>
            </div>
            <div style="font-size:0.85rem; color:#718096; margin-bottom:10px;">Subject Weightage Breakdown:</div>
            <div class="table-container">
            <table>
                <thead><tr><th>Subject</th><th>PYQ</th><th>%</th></tr></thead>
                <tbody>${summary.map(s => `<tr><td>${s.subject}</td><td>${s.totalPYQ}</td><td><strong>${s.score.toFixed(0)}</strong></td></tr>`).join('')}</tbody>
            </table>
            </div>
        `;
        
        destroyCharts();
        // Horizontal Bar
        new Chart(document.getElementById('mainChart'), {
            type: 'bar',
            data: {
                labels: summary.map(s=>s.subject),
                datasets: [{ label: 'Score', data: summary.map(s=>s.score), backgroundColor: COLORS, borderRadius: 4 }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        
        // Polar
        new Chart(document.getElementById('secondaryChart'), {
            type: 'polarArea',
            data: {
                labels: summary.map(s=>s.subject),
                datasets: [{ data: summary.map(s=>s.totalPYQ), backgroundColor: COLORS.map(c=>c+'99') }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false } } } }
        });
    }

    // --- VIEW 3: Pareto (Filters Outliers) ---
    async function loadPareto() {
      resetUI(); document.getElementById('paretoBtn').classList.add('active');
      
      // Filter Buttons
      const buttons = Array.from(document.querySelectorAll('.btn[data-file]'))
        .filter(btn => !IGNORED_FILES.has(btn.dataset.file));
      
      const fetchPromises = buttons.map(async btn => {
        const d = await fetchData(btn.dataset.file);
        return d ? { subject: btn.textContent, data: d } : null;
      });

      const results = (await Promise.all(fetchPromises)).filter(r => r !== null);
      loader.classList.add('hidden'); paretoDashboard.classList.remove('hidden');
      processParetoData(results);
    }

    function processParetoData(results) {
        const buckets = { l1: [], l2: [], l3: [], opt: [] };
        
        results.forEach(sub => {
            const sorted = [...sub.data].sort((a,b)=>b.pyq - a.pyq);
            const total = sorted.reduce((s,t)=>s+t.pyq,0);
            let run = 0;
            sorted.forEach(t => {
                run += t.pyq;
                const prevPct = ((run - t.pyq)/total)*100;
                const html = `
                    <div class="p-card">
                        <div class="p-info"><span class="p-subj">${sub.subject}</span><span class="p-topic">${t.topic}</span></div>
                        <span class="p-score">${t.pyq}</span>
                    </div>`;
                
                if(prevPct < 50) buckets.l1.push({html, v: t.pyq});
                else if(prevPct < 80) buckets.l2.push({html, v: t.pyq});
                else if(prevPct < 95) buckets.l3.push({html, v: t.pyq});
                else buckets.opt.push({html, v: t.pyq});
            });
        });

        const sort = (a,b) => b.v - a.v;
        document.getElementById('lvl1Content').innerHTML = buckets.l1.sort(sort).map(i=>i.html).join('');
        document.getElementById('lvl2Content').innerHTML = buckets.l2.sort(sort).map(i=>i.html).join('');
        document.getElementById('lvl3Content').innerHTML = buckets.l3.sort(sort).map(i=>i.html).join('');
        document.getElementById('lvlOptContent').innerHTML = buckets.opt.sort(sort).map(i=>i.html).join('');
    }

    // --- VIEW 4: Timeline & Roadmap (Filters Outliers) ---
    async function loadTimeline() {
        resetUI(); document.getElementById('timelineBtn').classList.add('active');
        
        // 1. Get All Data & Categorize
        // Filter Buttons
        const buttons = Array.from(document.querySelectorAll('.btn[data-file]'))
            .filter(btn => !IGNORED_FILES.has(btn.dataset.file));

        const fetchPromises = buttons.map(async btn => {
            const d = await fetchData(btn.dataset.file);
            return d ? { subject: btn.textContent, data: d } : null;
        });

        const results = (await Promise.all(fetchPromises)).filter(r => r !== null);
        const buckets = categorizeAllTopics(results);
        
        // 2. Date Math
        const today = new Date(); // Dec 10, 2025
        const examDate = new Date("2026-02-05");
        const diffMs = examDate - today;
        const totalDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        
        // 3. Strategic Calculation
        // Assumption: Vital topics take slightly longer to master, but we treat topic units as equal for simplicity here.
        // We calculate deadlines based on sequential mastery.
        const totalTopics = buckets.totalTopics;
        const velocity = totalTopics / totalDays; // Avg topics needed per day for 100% completion

        // Milestone 1: Finish L1
        const daysForL1 = Math.ceil(buckets.l1.length / velocity);
        const dateL1 = new Date(today); dateL1.setDate(today.getDate() + daysForL1);

        // Milestone 2: Finish L2
        const daysForL2 = Math.ceil(buckets.l2.length / velocity);
        const dateL2 = new Date(dateL1); dateL2.setDate(dateL1.getDate() + daysForL2);

        // Milestone 3: Finish L3+Opt
        // This lands us on exam date basically.
        
        const fmtDate = (d) => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});

        // 4. Render Roadmap Cards
        loader.classList.add('hidden'); timelineDashboard.classList.remove('hidden');
        document.getElementById('roadmapCards').innerHTML = `
            <div class="phase-card phase-1">
                <h4><i class="ph-fill ph-flag"></i> Phase 1: The Vital Few</h4>
                <div class="date">${fmtDate(dateL1)}</div>
                <div class="meta">Deadline to finish ${buckets.l1.length} high-impact topics.</div>
                <div class="velocity-pill">Target: ${(buckets.l1.length/daysForL1).toFixed(1)} topics/day</div>
            </div>

            <div class="phase-card phase-2">
                <h4><i class="ph-fill ph-check-square"></i> Phase 2: Core Concepts</h4>
                <div class="date">${fmtDate(dateL2)}</div>
                <div class="meta">Deadline for next ${buckets.l2.length} medium topics.</div>
                <div class="velocity-pill">Maintain Pace</div>
            </div>

            <div class="phase-card phase-3">
                <h4><i class="ph-fill ph-trophy"></i> Phase 3: Final Push</h4>
                <div class="date">${fmtDate(examDate)}</div>
                <div class="meta">Finish remaining ${buckets.l3.length + buckets.opt.length} topics + Revision.</div>
                <div class="velocity-pill">Exam Day</div>
            </div>
        `;

        // 5. Render Strategic Burndown Chart
        destroyCharts();
        const ctx = document.getElementById('timelineChart').getContext('2d');
        
        // Generate ideal line
        const labels = [];
        const idealData = [];
        const dataPoints = 10;
        const interval = Math.floor(totalDays / dataPoints);
        
        for(let i=0; i<=dataPoints; i++) {
            const d = new Date();
            d.setDate(today.getDate() + (i * interval));
            labels.push(fmtDate(d));
            idealData.push(Math.max(0, totalTopics - (velocity * i * interval)));
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Topics Remaining',
                    data: idealData,
                    borderColor: '#319795',
                    backgroundColor: 'rgba(49, 151, 149, 0.05)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: labels.indexOf(fmtDate(dateL1)) > -1 ? labels.indexOf(fmtDate(dateL1)) : 2, // Approx index if exact match fails
                                xMax: labels.indexOf(fmtDate(dateL1)) > -1 ? labels.indexOf(fmtDate(dateL1)) : 2,
                                borderColor: '#c53030',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: { display: true, content: 'Phase 1 Done', position: 'start', backgroundColor: '#c53030', color: 'white' }
                            },
                            line2: {
                                type: 'line',
                                xMin: labels.indexOf(fmtDate(dateL2)) > -1 ? labels.indexOf(fmtDate(dateL2)) : 5,
                                xMax: labels.indexOf(fmtDate(dateL2)) > -1 ? labels.indexOf(fmtDate(dateL2)) : 5,
                                borderColor: '#d69e2e',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: { display: true, content: 'Phase 2 Done', position: 'start', backgroundColor: '#d69e2e', color: 'white' }
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display:true, text:'Topics Remaining' } }
                }
            }
        });
    }

    // --- Event Listeners ---
    document.querySelectorAll('.btn[data-file]').forEach(btn => btn.addEventListener('click', () => loadSubject(btn)));
    document.getElementById('overallBtn').addEventListener('click', loadOverall);
    document.getElementById('paretoBtn').addEventListener('click', loadPareto);
    document.getElementById('timelineBtn').addEventListener('click', loadTimeline);

  </script>
</body>
</html>
